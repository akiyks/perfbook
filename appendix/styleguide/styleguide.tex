% appendix/styleguide/styleguide.tex
% mainfile: ../../perfbook.tex
% SPDX-License-Identifier: CC-BY-SA-3.0

\chapter{Style Guide}
\label{chp:app:styleguide:Style Guide}
%
\Epigraph{De gustibus non est disputandum.}{Latin maxim}

This appendix is a collection of style guides which is intended
as a reference to improve consistency in perfbook.
It also contains several suggestions and their experimental examples.

\Cref{sec:app:styleguide:Paul's Conventions} describes basic
punctuation and spelling rules.
\Cref{sec:app:styleguide:NIST Style Guide} explains rules
related to unit symbols.
\Cref{sec:app:styleguide:LaTeX Conventions} summarizes
\LaTeX-specific conventions.

\section{Paul's Conventions}
\label{sec:app:styleguide:Paul's Conventions}

Following is the list of Paul's conventions assembled from his
answers to Akira's questions regarding perfbook's punctuation policy.

\begin{itemize}
\item (On punctuations and quotations)
  Despite being American myself, for this sort of book, the UK approach
  is better because it removes ambiguities like the following:
  \begin{quote}
    Type ``\nbco{ls -a},'' look for the file ``\co{.},''
    and file a bug if you don't see it.
  \end{quote}

  The following is much more clear:
  \begin{quote}
    Type ``\nbco{ls -a}'', look for the file ``\co{.}'',
    and file a bug if you don't see it.
  \end{quote}
\item American English spelling: ``color'' rather than ``colour''.
\item Oxford comma: ``a, b, and~c'' rather than ``a, b and~c''.
  This is arbitrary.
  Cases where the Oxford comma results in ambiguity should be reworded,
  for example, by introducing numbering:  ``a, b, and c and~d'' should
  be ``(1)~a, (2)~b, and (3)~c and~d''.
\item Italic for emphasis.
  Use sparingly.
\item \verb|\co{}| for identifiers, \verb|\url{}| for URLs,
  \verb|\path{}| for filenames.
\item Dates should use an unambiguous format.
  Never ``mm/dd/yy'' or ``dd/mm/yy'', but rather ``July 26, 2016''
  or ``26 July 2016'' or ``26-Jul-2016'' or ``2016/07/26''.
  I tend to use \path{yyyy.mm.ddA} for filenames, for example.
\item North American rules on periods and abbreviations.
  For example neither of the following can reasonably be interpreted
  as two sentences:
  \begin{itemize}
  \item Say hello, to Mr.~Jones.
  \item If it looks like she sprained her ankle, call Dr.~Smith and
    then tell her to keep the ankle iced and elevated.
  \end{itemize}

  An ambiguous example:
  \begin{quote}
    If I take the cow, the pig, the horse, etc. George will be upset.
  \end{quote}
  can be written with more words:
  \begin{quote}
    If I take the cow, the pig, the horse, or much of anything else,
    George will be upset.
  \end{quote}
  or:
  \begin{quote}
    If I take the cow, the pig, the horse, etc., George will be upset.
  \end{quote}
\item I don't like ampersand (``\&'') in headings, but will sometimes
  use it if doing so prevents a line break in that heading.
\item When mentioning words, I use quotations.
  When introducing a new word, I use \verb|\emph{}|.
\end{itemize}

Following is a convention regarding punctuation in \LaTeX\ sources.

\begin{itemize}
\item Place a newline after a colon (\co{:}) and the end of a sentence.
  This avoids the whole one-space/two-space food fight and also has
  the advantage of more clearly showing changes to single sentences
  in the middle of long paragraphs.
\end{itemize}

\section{NIST Style Guide}
\label{sec:app:styleguide:NIST Style Guide}

\subsection{Unit Symbol}
\label{sec:app:styleguide:Unit Symbol}

\subsubsection{SI Unit Symbol}
\label{sec:app:styleguide:SI Unit Symbol}

NIST style guide~\cite[Chapter 5]{NIST:SP:330:2019}
states the following rules (rephrased for perfbook).

\begin{itemize}
\item When SI unit symbols such as ``ns'', ``MHz'', and ``K'' (kelvin)
are used behind numerical values, narrow spaces should be placed between
the values and the symbols.

A narrow space can be coded in \LaTeX{} by the sequence of \qco{\\,}.
For example,
\begin{quote}
  ``2.4\,GHz'', rather then ``2.4GHz''.
\end{quote}

\item Even when the value is used in adjectival sense, a narrow space
  should be placed.
  For example,
\begin{quote}
  ``a~10\,ms interval'', rather than ``a~10\=/ms interval'' nor
  ``a~10ms interval''.
\end{quote}
\end{itemize}

The symbol of micro (\micro :$10^{-6}$) can be typeset easily by
the help of ``gensymb'' \LaTeX\ package.
A macro \qco{\\micro} can be used in both text and math modes.
To typeset the symbol of ``microsecond'', you can do
so by \qco{\\micro s}.
For example,
\begin{quote}
  10\,\micro s
\end{quote}

Note that math mode \qco{\\mu} is italic by default and should not
be used as a prefix.
An improper example:
\begin{quote}
  10\,$\mu $s (math mode \qco{\\mu})
\end{quote}

\subsubsection{Non-SI Unit Symbol}
\label{sec:app:styleguide:Non-SI Unit Symbol}

Although NIST style guide does not cover non-SI unit symbols
such as ``KB'', ``MB'', and ``GB'', the same rule should be followed.

Example:

\begin{quote}
  ``A~240\,GB hard drive'', rather than ``a~240\=/GB hard drive''
  nor ``a~240GB hard drive''.
\end{quote}

Strictly speaking, NIST guide requires us to use the binary prefixes
``Ki'', ``Mi'', or ``Gi'' to represent powers of~$2^{10}$.
However, we accept the JEDEC conventions to use ``K'', ``M'',
and ``G'' as binary prefixes in describing memory
capacity~\cite{JEDEC:dict:prefixmega}.

An acceptable example:
\begin{quote}
  ``8\,GB of main memory'', meaning ``8\,GiB of main memory''.
\end{quote}

Also, it is acceptable to use just ``K'', ``M'', or ``G'' as abbreviations
appended to a numerical value, e.g., ``4K~entries''.
In such cases, no space before an abbreviation is required.
For example,

\begin{quote}
  ``8K entries'', rather than ``8\,K entries''.
\end{quote}

If you put a space in between, the symbol looks like a unit symbol and
is confusing.
Note that ``K'' and ``k'' represent $2^{10}$ and $10^3$, respectively.
``M'' can represent either $2^{20}$ or $10^6$, and ``G'' can represent
either $2^{30}$ or $10^9$.
These ambiguities should not be confusing in discussing approximate order.

\subsubsection{Degree Symbol}
\label{sec:app:styleguide:Degree Symbol}

The angular-degree symbol (\degree) does not require any space in front
of it.
NIST style guide clearly states so.

The symbol of degree can also be typeset easily by the help of gensymb
package.
A macro \qco{\\degree} can be used in both text and math modes.

Example:

\begin{quote}
  $45\degree$, rather than $45\,\degree$.
\end{quote}

\subsubsection{Percent Symbol}
\label{sec:app:styleguide:Percent Symbol}

NIST style guide treats the percent symbol (\%) as the same as SI unit
symbols.

\begin{quote}
  50\,\% possibility, rather than 50\% possibility.
\end{quote}

\subsubsection{Font Style}
\label{sec:app:styleguide:Font Style}

Quote from NIST check list~\cite[\#6]{NIST:UnitCheckList}:

\begin{quote}
  Variables and quantity symbols are in italic type.
  Unit symbols are in roman type.
  Numbers should generally be written in roman type.
  These rules apply irrespective of the typeface used in the surrounding
  text.
\end{quote}

For example,
\begin{quote}
  {\textit e} (elementary charge)
\end{quote}

On the other hand, mathematical constants such as the base
of natural logarithms should be roman~\cite{NIST:TypeFaces}.
For example,

\begin{quote}
  $\mathrm{e}^x$
\end{quote}

%\footnote{
%  See \url{https://tex.stackexchange.com/questions/119248/}
%  for the historical reason.}

\subsection{NIST Guide Yet To Be Followed}
\label{sec:app:styleguide:NIST Guides Yet To Be Followed}

There are a few cases where NIST style guide is not followed.
Other English conventions are followed in such cases.

\subsubsection{Digit Grouping}
\label{sec:app:styleguide:Digit Grouping}

Quote from NIST checklist~\cite[\#16]{NIST:UnitCheckList}:

\begin{quote}
  The digits of numerical values having more than four digits on either
  side of the decimal marker are separated into groups of three using
  a thin, fixed space counting from both the left and right of the decimal
  marker.
  Commas are not used to separate digits into groups of three.
\end{quote}

\begin{quote}
\begin{tabular}{ll}
  NIST Example:& 15\,739.012\,53\,ms\\
  Our convention:& 15,739.01253\,ms\\
\end{tabular}
\end{quote}

In \LaTeX\ coding, it is cumbersome to place thin spaces as are recommended
in NIST guide.
The \verb|\num{}| command provided by the ``siunitx'' package would be
of help for us to follow this rule.
It would also help us overcome different conventions.
We can select a specific digit-grouping style as
a default in preamble, or specify an option to each \verb|\num{}|
command as is shown in
\cref{tab:app:styleguide:Digit-Grouping Style}.

\newcommand{\NumDigitGrpA}{12 345}
\newcommand{\NumDigitGrpB}{12.345}
\newcommand{\NumDigitGrp}{1 234 567.89}
\begin{table}
\small\centering
\begin{tabular}{lrrr}\toprule
  Style & \multicolumn{3}{c}{Outputs of \co{\\num\{\}}} \\
  \midrule
  NIST/SI (English) & \num[group-separator={\,},group-digits=integer]{\NumDigitGrpA} &
    \num[group-separator={\,},group-digits=integer]{\NumDigitGrpB} &
      \num[group-separator={\,},group-digits=integer]{\NumDigitGrp} \\
  SI (French) & \num[locale=FR,group-separator={\,}]{\NumDigitGrpA} &
    \num[locale=FR,group-separator={\,}]{\NumDigitGrpB} &
      \num[locale=FR,group-separator={\,}]{\NumDigitGrp} \\
  English & \num[group-separator={,},group-digits=integer]{\NumDigitGrpA} &
    \num[group-separator={,},group-digits=integer]{\NumDigitGrpB} &
      \num[group-separator={,},group-digits=integer]{\NumDigitGrp} \\
  French & \num[locale=FR,group-separator={\,}]{\NumDigitGrpA} &
    \num[locale=FR,group-separator={\,}]{\NumDigitGrpB} &
      \num[locale=FR,group-separator={\,}]{\NumDigitGrp} \\
  Other Europe & \num[group-separator={.},output-decimal-marker={,},group-digits=integer]{\NumDigitGrpA} &
    \num[group-separator={.},output-decimal-marker={,},group-digits=integer]{\NumDigitGrpB} &
      \num[group-separator={.},output-decimal-marker={,},group-digits=integer]{\NumDigitGrp} \\
\bottomrule
\end{tabular}
\caption{Digit-Grouping Style}
\label{tab:app:styleguide:Digit-Grouping Style}
\end{table}

As are evident in
\cref{tab:app:styleguide:Digit-Grouping Style},
periods and commas used as other than decimal markers are confusing
and should be avoided, especially in documents expecting global
audiences.

By marking up constant decimal values by \verb|\num{}| commands,
the \LaTeX\ source would be exempted from any particular conventions.

Because of its open-source policy, this approach should give
more ``portability'' to perfbook.

\section{\LaTeX\ Conventions}
\label{sec:app:styleguide:LaTeX Conventions}

Good looking \LaTeX\ documents require further considerations
on proper use of font styles, line break exceptions, etc.
This section summarizes guidelines specific to \LaTeX.

\subsection{Monospace Font}
\label{sec:app:styleguide:Monospace Font}

Monospace font (or typewriter font) is heavily used in this textbook.
First policy regarding monospace font in perfbook is to avoid
directly using \qco{\\texttt} or \qco{\\tt} macro.
It is highly recommended to use a macro or an environment
indicating the reason why you want the font.

This section explains the use cases of such macros and environments.

\subsubsection{Code Snippet}
\label{sec:app:styleguide:Code Snippet}

Because the \qco{verbatim} environment is a primitive way to include
listings, we have transitioned to a scheme which uses
the \qco{fancyvrb} package for code snippets.

The goal of the scheme is to extract \LaTeX\ sources of
code snippets directly from code samples under \path{CodeSamples}
directory.
It also makes it possible to embed line labels in the code samples,
which can be referenced within the \LaTeX\ sources.
This reduces the burden of keeping line numbers
in the text consistent with those in code snippets.

Code-snippet extraction is handled by a couple of
perl scripts and recipes in Makefile.
We use the escaping feature of the \co{fancyvrb} package
to embed line labels as comments.

We used to use the \qco{verbbox} environment provided
by the \qco{verbatimbox} package.
\Cref{sec:app:styleguide:Code Snippet (Obsolete)} describes how
\co{verbbox} can automatically generate line numbers,
but those line numbers cannot be referenced within the \LaTeX\ sources.

Let's start by looking at how code snippets are coded in the current scheme.
There are three customized environments of \qco{Verbatim}.
\qco{VerbatimL} is for floating snippets within the \qco{listing}
environment.
\qco{VerbatimN} is for inline snippets with line count enabled.
\qco{VerbatimU} is for inline snippets without line count.
They are defined in the preamble as shown below:

\begin{VerbatimU}
\DefineVerbatimEnvironment{VerbatimL}{Verbatim}%
  {fontsize=\scriptsize,numbers=left,numbersep=5pt,%
    xleftmargin=9pt,obeytabs=true,tabsize=2}
\AfterEndEnvironment{VerbatimL}{\vspace*{-9pt}}
\DefineVerbatimEnvironment{VerbatimN}{Verbatim}%
  {fontsize=\scriptsize,numbers=left,numbersep=3pt,%
    xleftmargin=5pt,xrightmargin=5pt,obeytabs=true,%
    tabsize=2,frame=single}
\DefineVerbatimEnvironment{VerbatimU}{Verbatim}%
  {fontsize=\scriptsize,numbers=none,xleftmargin=5pt,%
    xrightmargin=5pt,obeytabs=true,tabsize=2,%
    samepage=true,frame=single}
\end{VerbatimU}

% Another option would be the ``lstlisting'' environment provided
%  by the ``listings'' package. We are already using its ``lstinline''
%  command in the definition of \co{\\co\{\}} macro.

\begin{listing}
\fvset{fontsize=\scriptsize,numbers=left,numbersep=5pt,xleftmargin=9pt,obeytabs=true,tabsize=8,commandchars=\%\~\^}
\begin{fcvlabel}[ln:app:styleguide:LaTeX Source of Sample Code Snippet (Current)]
\VerbatimInput{appendix/styleguide/samplecodesnippetfcv.tex}
\end{fcvlabel}
\vspace*{-9pt}
\caption{\LaTeX\ Source of Sample Code Snippet (Current)}
\label{lst:app:styleguide:LaTeX Source of Sample Code Snippet (Current)}
\end{listing}

\input{appendix/styleguide/samplecodesnippetfcv.tex}

The \LaTeX\ source of a sample code snippet is shown in
\cref{lst:app:styleguide:LaTeX Source of Sample Code Snippet (Current)}
and is typeset as shown in
\cref{lst:app:styleguide:Sample Code Snippet}.

Labels to lines are specified in \qco{$lnlbl[]} command.
The characters specified by \qco{commandchars} option to \co{VarbatimL}
environment are used by the \co{fancyvrb} package to substitute
\qco{\\lnlbl\{\}} for \qco{$lnlbl[]}.
Those characters should be selected so that they don't appear
elsewhere in the code snippet.

Labels \qco{printf} and \qco{return} in
\cref{lst:app:styleguide:Sample Code Snippet}
can be referred to as shown below:

\begin{VerbatimU}
\begin{fcvref}[ln:base1]
\Clnref{printf, return} can be referred
to from text.
\end{fcvref}
\end{VerbatimU}

Above code results in the paragraph below:

\begin{quote}
\begin{fcvref}[ln:base1]
\Clnref{printf, return} can be referred
to from text.
\end{fcvref}
\end{quote}

Macros \qco{\\lnlbl\{\}} and \qco{\\lnref\{\}} are defined in
the preamble as follows:

\begin{VerbatimU}
\newcommand{\lnlblbase}{}
\newcommand{\lnlbl}[1]{%
  \phantomsection\label{\lnlblbase:#1}}
\newcommand{\lnrefbase}{}
\newcommand{\lnref}[1]{\ref{\lnrefbase:#1}}
\end{VerbatimU}

Environments \qco{fcvlabel} and \qco{fcvref} are defined as
shown below:

\begin{VerbatimU}
\newenvironment{fcvlabel}[1][]{%
  \renewcommand{\lnlblbase}{#1}%
  \ignorespaces}{\ignorespacesafterend}
\newenvironment{fcvref}[1][]{%
  \renewcommand{\lnrefbase}{#1}%
  \ignorespaces}{\ignorespacesafterend}
\end{VerbatimU}

\begin{fcvref}[ln:app:styleguide:LaTeX Source of Sample Code Snippet (Current)]
The main part of \LaTeX\ source shown on
\clnrefrange{beg:fcvlabel}{end:fcvlabel} in
\cref{lst:app:styleguide:LaTeX Source of Sample Code Snippet (Current)}
can be extracted from a code sample of
\cref{lst:app:styleguide:Source of Code Sample} by a perl script
\path{utilities/fcvextract.pl}.
All the relevant rules of extraction are described as recipes in the
top level \path{Makefile} and a script to generate dependencies
(\path{utilities/gen_snippet_d.pl}).
\end{fcvref}

\begin{listing*}
\fvset{fontsize=\scriptsize,numbers=left,numbersep=5pt,xleftmargin=9pt,obeytabs=true,tabsize=8}
\VerbatimInput{appendix/styleguide/samplecodesnippet.c}
\vspace*{-9pt}
\caption{Source of Code Sample with ``snippet'' Meta Command}
\label{lst:app:styleguide:Source of Code Sample}
\end{listing*}

As you can see, \cref{lst:app:styleguide:Source of Code Sample}
has meta commands in comments of C (C++ style).
Those meta commands are interpreted by \path{utilities/fcvextract.pl},
which distinguishes the type of comment style by the suffix of code
sample's file name.

Meta commands which can be used in code samples are listed below:

\begin{itemize}[noitemsep]
\item \co{\\begin\{snippet\}[<options>]}
\item \co{\\end\{snippet\}}
\item \co{\\lnlbl\{<label string>\}}
\item \co{\\fcvexclude}
\item \co{\\fcvblank}
\end{itemize}

\qco{<options>} to the \co{\\begin\{snippet\}} meta command
is a comma-spareted list of options shown below:

\begin{itemize}[noitemsep]
\item \co{labelbase=<label base string>}
\item \co{keepcomment=yes}
\item \co{gobbleblank=yes}
\item \co{commandchars=\\X\\Y\\Z}
\end{itemize}

The \qco{labelbase} option is mandatory and the string given to it
will be passed to the
``\co{\\begin\{fcvlabel\}[<label base string>]}'' command as shown on
\clnrefr{ln:app:styleguide:LaTeX Source of Sample Code Snippet (Current):beg:fcvlabel} of
\cref{lst:app:styleguide:LaTeX Source of Sample Code Snippet (Current)}.
The \qco{keepcomment=yes} option tells \co{fcvextract.pl} to keep
comment blocks.
Otherwise, comment blocks in C source code will be omitted.
The \qco{gobbleblank=yes} option will remove empty or blank lines
in the resulting snippet.
The \qco{commandchars} option is given to the \co{VerbatimL} environment
as is.
At the moment, it is also mandatory and must come at the end of options
listed above.
Other types of options, if any, are also passed to the \co{VerbatimL}
environment.

The \qco{\\lnlbl} commands are converted along the way to reflect
the escape-character choice.\footnote{
	Characters forming comments around the \qco{\\lnlbl} commands
	are also gobbled up regardless of the \qco{keepcomment} setting.
}
Source lines with \qco{\\fcvexclude} are removed.
\qco{\\fcvblank} can be used to keep blank lines when the
\qco{gobbleblank=yes} option is specified.

There can be multiple pairs of \co{\\begin\{snippet\}} and \co{\\end\{snippet\}}
as long as they have unique \qco{labelbase} strings.

Our naming scheme of \qco{labelbase} for unique name space is as follows:

\begin{VerbatimU}
ln:<Chapter/Subdirectory>:<File Name>:<Function Name>
\end{VerbatimU}

Litmus tests, which are handled by \qco{herdtools7} commands such as
\qco{litmus7} and \qco{herd7}, were problematic in this scheme.
Those commands have particular rules of where comments can be
placed and restriction on permitted characters in comments.
They also forbid a couple of tokens to appear in comments.
(Tokens in comments might sound strange, but they do have such restriction.)

For example, the first token in a litmus test must be one of
\qco{C}, \qco{PPC}, \qco{X86}, \qco{LISA}, etc., which indicates
the flavor of the test.
This means no comment is allowed at the beginning of a litmus test.

Similarly, several tokens such as \qco{exists}, \qco{filter},
and~\qco{locations} indicate the end of litmus test's body.
Once one of them appears in a litmus test, comments should be of
OCaml style (\qco{(* ... *)}).
Those tokens keep the same meaning even when they appear in comments!

The pair of characters \qco{\{} and \qco{\}} also have special
meaning in the C flavour tests.
They are used to separate portions in a litmus test.

First pair of \qco{\{} and \qco{\}} encloses initialization part.
Comments in this part should also be in the ocaml form.

You can't use \qco{\{} and \qco{\}} in comments in litmus tests, either.

Examples of disallowed comments in a litmus test are shown below:

\begin{fcvlabel}[ln:app:styleguide:Bad comments in Litmus Test]
\begin{VerbatimN}[tabsize=8]
// Comment at first
C C-sample
// Comment with { and } characters
{
x=2;  // C style comment in initialization
}

P0(int *x}
{
	int r1;

	r1 = READ_ONCE(*x);  // Comment with "exists"
}

[...]

exists (0:r1=0)  // C++ style comment after test body
\end{VerbatimN}
\end{fcvlabel}

To avoid parse errors, meta commands in litmus tests (C flavor) are embedded
in the following way.

\begin{fcvlabel}[ln:app:styleguide:Sample Source of Litmus Test]
\begin{VerbatimN}[tabsize=8]
C C-SB+o-o+o-o
//\begin[snippet][labelbase=ln:base,commandchars=\%\@\$]

{
1:r2=0			(*\lnlbl[initr2]*)
}

P0(int *x0, int *x1)		//\lnlbl[P0:b]
{
	int r2;

	WRITE_ONCE(*x0, 2);
	r2 = READ_ONCE(*x1);
}				//\lnlbl[P0:e]

P1(int *x0, int *x1)
{
	int r2;

	WRITE_ONCE(*x1, 2);
	r2 = READ_ONCE(*x0);
}

//\end[snippet]
exists (1:r2=0 /\ 0:r2=0)  (* \lnlbl[exists_] *)
\end{VerbatimN}
\end{fcvlabel}

Example above is converted to the following intermediate code
by a script \path{utilities/reorder_ltms.pl}.\footnote{
	Currently, only C flavor litmus tests are supported.
}
The intermediate code can be handled
by the common script \path{utilities/fcvextract.pl}.

\begin{fcvlabel}[ln:app:styleguide:Intermediate Source of Litmus Test]
\begin{VerbatimN}[tabsize=8]
// Do not edit!
// Generated by utillities/reorder_ltms.pl
//\begin{snippet}[labelbase=ln:base,commandchars=\%\@\$]
C C-SB+o-o+o-o

{
1:r2=0			//\lnlbl{initr2}
}

P0(int *x0, int *x1)		//\lnlbl{P0:b}
{
	int r2;

	WRITE_ONCE(*x0, 2);
	r2 = READ_ONCE(*x1);
}				//\lnlbl{P0:e}

P1(int *x0, int *x1)
{
	int r2;

	WRITE_ONCE(*x1, 2);
	r2 = READ_ONCE(*x0);
}

exists (1:r2=0 /\ 0:r2=0)  \lnlbl{exists_}
//\end{snippet}
\end{VerbatimN}
\end{fcvlabel}

Note that each litmus test's source file can contain at most one
pair of \co{\\begin[snippet]} and \co{\\end[snippet]} because of
the restriction of comments.

\subsubsection{Code Snippet (Obsolete)}
\label{sec:app:styleguide:Code Snippet (Obsolete)}

Sample \LaTeX\ source of a code snippet coded using
the \qco{verbatimbox} package is shown in
\cref{lst:app:styleguide:LaTeX Source of Sample Code Snippet (Obsolete)}
and is typeset as shown in
\cref{lst:app:styleguide:Sample Code Snippet (Obsolete)}.

\begin{listing}
\begin{fcvlabel}[ln:app:styleguide:samplecodesnippetlstlbl]
\fvset{fontsize=\scriptsize,numbers=left,numbersep=5pt,xleftmargin=9pt,commandchars=\%\@\$}
\VerbatimInput{appendix/styleguide/samplecodesnippetlstlbl.tex}
\end{fcvlabel}
\vspace*{-9pt}
\caption{\LaTeX\ Source of Sample Code Snippet (Obsolete)}
\label{lst:app:styleguide:LaTeX Source of Sample Code Snippet (Obsolete)}
\end{listing}

\input{appendix/styleguide/samplecodesnippetlst.tex}

The auto\-/numbering feature of \co{verbbox} is enabled by
the ``\verb|\LstLineNo|'' macro specified in the option to verbbox
(\clnrefr{ln:app:styleguide:samplecodesnippetlstlbl:lineno} in
\cref{lst:app:styleguide:LaTeX Source of Sample Code Snippet (Obsolete)}).
The macro is defined in the preamble of \path{perfbook.tex}
as follows:

\begin{VerbatimU}
\newcommand{\LstLineNo}
  {\makebox[5ex][r]{\arabic{VerbboxLineNo}\hspace{2ex}}}
\end{VerbatimU}

The \qco{verbatim} environment is used for listings with too many lines
to fit in a column.
It is also used to avoid overwhelming \LaTeX\ with a lot of floating objects.
They are being converted to the scheme using the \co{VerbatimN} environment.

\subsubsection{Identifier}
\label{sec:app:styleguide:Identifier}

We use ``\verb|\co{}|'' macro for inline identifiers.
(``co'' stands for ``code''.)

By putting them into \verb|\co{}|, underscore characters in
their names are free of escaping in \LaTeX\ source.
It is convenient to search them in source files.
Also, \verb|\co{}| macro has a capability to permit line breaks
at particular sequences of letters.
Current definition permits a line break at an underscore (\tco{_}),
two consecutive underscores (\tco{__}), a white space, or an
operator \tco{->}.

\subsubsection{Identifier inside Table and Heading}
\label{sec:app:styleguide:Identifier inside Table and Heading}

Although \verb|\co{}| command is convenient for inlining within text,
it is fragile because of its capability of line break.
When it is used inside a \qco{tabular} environment or its derivative
such as \qco{tabularx}, it confuses column width
estimation of those environments.
Furthermore, \verb|\co{}| can not be safely used in section headings nor
description headings.

As a workaround, we use ``\verb|\tco{}|'' command
inside tables and headings.
It has no capability of line break at particular sequences, but
still frees us from escaping underscores.

When used in text, \verb|\tco{}| permits line breaks at
white spaces.

\subsubsection{Other Use Cases of Monospace Font}
\label{sec:app:styleguide:Other Use Cases of Monospace Font}

For URLs, we use ``\verb|\url{}|'' command provided by the
\qco{hyperref} package.
It will generate hyper references to the URLs.

For path names, we use ``\verb|\path{}|'' command.
It won't generate hyper references.

Both \verb|\url{}| and \verb|\path{}| permit line breaks
at \qco{/}, \qco{-}, and \qco{.}.\footnote{
  Overfill can be a problem if the URL or the path name contains
  long runs of unbreakable characters.
}

For short monospace statements not to be line broken, we use
the ``\verb|\nbco{}|'' (non-breakable co) macro.

\subsubsection{Limitations}
\label{sec:app:styleguide:Limitations}

There are a few cases where macros introduced in this section
do not work as expected.
\Cref{tab:app:styleguide:Limitation of Monospace Macro}
lists such limitations.

\begin{table}
\renewcommand*{\arraystretch}{1.2}\centering\footnotesize
\begin{tabular}{@{}lll@{}}\toprule
  Macro &  Need Escape & Should Avoid \\
  \midrule
  \co{\\co}, \co{\\nbco} & \co{\\}, \%, \{, \} & \\
  \co{\\tco}  & \# & \%, \{, \}, \co{\\} \\
  \bottomrule
\end{tabular}
\caption{Limitation of Monospace Macro}
\label{tab:app:styleguide:Limitation of Monospace Macro}
\end{table}

While \verb|\co{}| requires some characters to be escaped,
it can contain any character.

On the other hand, \verb|\tco{}| can not handle
\qco{\%}, \qco{\{}, \qco{\}}, nor \qco{\\} properly.
If they are escaped by a~\qco{\\},
they appear in the end result with the escape character.
The \qco{\\verb} command can be used in running text if you
need to use monospace font for a string which contains
many characters to escape.\footnote{
  The \co{\\verb} command is not almighty though.
  For example, you can't use it within a footnote.
  If you do so, you will see a fatal \LaTeX\ error.
  A workaround would be a macro named \co{\\VerbatimFootnotes}
  provided by the \co{fancyvrb} package.
  Unfortunately, perfbook can't employ it due to the interference
  with the \co{footnotebackref} package.
  }

\subsection{Cross-reference}
\label{sec:app:styleguide:Cross-Reference}

Cross-references to \namecrefs{chp:Introduction},
\namecrefs{sec:intro:Parallel Programming Goals},
\namecrefs{lst:app:styleguide:Source of Code Sample}, etc.\@ have
been expressed by combinations of names and bare \verb|\ref{}|
commands in the following way:

\begin{VerbatimN}
Chapter~\ref{chp:Introduction},
Table~\ref{tab:app:styleguide:Digit-Grouping Style}
\end{VerbatimN}

This is a traditional way of cross\-/referencing.
However, it is tedious and sometimes error-prone to put a name
manually on every cross\-/reference.
The \co{cleveref} package provides a nicer way of cross\-/referencing.
A few examples follow:

\begin{VerbatimN}
\Cref{chp:Introduction},
\cref{sec:intro:Parallel Programming Goals},
\cref{chp:app:styleguide:Style Guide},
\cref{tab:app:styleguide:Digit-Grouping Style}, and
\cref{lst:app:styleguide:Source of Code Sample} are
examples of cross\-/references.
\end{VerbatimN}

Above code is typeset as follows:

\begin{quote}
\Cref{chp:Introduction},
\cref{sec:intro:Parallel Programming Goals},
\cref{chp:app:styleguide:Style Guide},
\cref{tab:app:styleguide:Digit-Grouping Style}, and
\cref{lst:app:styleguide:Source of Code Sample} are
examples of cross\-/references.
\end{quote}

As you can see, naming of cross\-/references is automated.
Current setting generates capitalized names for both of
\verb|\Cref{}| and \verb|\cref{}|, but the former
should be used at the beginning of a sentence.

We are in the middle of conversion to
\co{cleveref}-style cross\-/referencing.

Cross-references to line numbers of code snippets
can be done in a similar way by using \verb|\Clnref{}| and
\verb|\clnref{}| macros, which mimic \co{cleveref}.
The former puts ``Line'' as the name of the reference
and the latter ``line''.

Please refer to \co{cleveref}'s documentation for further
info on its cleverness.

\subsection{Non Breakable Spaces}
\label{sec:app:styleguide:Non Breakable Spaces}

In \LaTeX\ conventions, proper use of non-breakable white spaces
is highly recommended.
They can prevent widowing and orphaning of single digit numbers
or short variable names, which would cause the text to be confusing
at first glance.

The thin space mentioned earlier to be placed in front of a unit
symbol is non breakable.

Other cases to use a non-breakable space (``\verb|~|'' in \LaTeX\
source, often referred to as ``nbsp'')
are the following (inexhaustive).

\begin{itemize}
\item Reference to a Chapter or a Section:
  \begin{quote}
    Please refer to \cref{sec:app:styleguide:NIST Style Guide}.
  \end{quote}
\item Calling out CPU number or Thread name:
  \begin{quote}
    After they load the pointer, CPUs~1 and~2 will see the stored
    value.
  \end{quote}
\item Short variable name:
  \begin{quote}
    The results will be stored in variables~\co{a} and~\co{b}.
  \end{quote}
\end{itemize}

\subsection{Hyphenation and Dashes}
\label{sec:app:styleguide:Hyphenation and Dashes}

\subsubsection{Hyphenation in Compound Word}
\label{sec:app:styleguide:Hyphenation in Compound Word}

In plain \LaTeX, compound words such as ``high-frequency''
can be hyphenated only at the hyphen.
This sometimes results in poor typesetting.
For example:

\begin{center}\begin{minipage}{2.6in}\vspace{0.6\baselineskip}
  High-frequency radio wave, high-frequency radio wave,
  high-frequency radio wave, high-frequency radio wave,
  high-frequency radio wave, high-frequency radio wave.
\vspace{0.6\baselineskip}\end{minipage}\end{center}

By using a shortcut \qco{\\-/} provided by the
``extdash'' package, hyphenation in elements of compound
words is enabled in perfbook.\footnote{
  In exchange for enabling the shortcut, we can't use plain
  \LaTeX's shortcut \qco{\\-} to specify hyphenation points.
  Use \path{pfhyphex.tex} to add such exceptions.
}

Example with \qco{\\-/}:

\begin{center}\begin{minipage}{2.6in}\vspace{0.6\baselineskip}
  High\-/frequency radio wave, high\-/frequency radio wave,
  high\-/frequency radio wave, high\-/frequency radio wave,
  high\-/frequency radio wave, high\-/frequency radio wave.
\vspace{0.6\baselineskip}\end{minipage}\end{center}

\subsubsection{Non Breakable Hyphen}
\label{sec:app:styleguide:Non Breakable Hyphen}

We want hyphenated compound terms such as ``x\=/coordinate'',
``y\=/coordinate'', etc.\@ not to be broken at the hyphen
following a single letter.

To make a hyphen unbreakable, we can use a short cut
\qco{\\=/} also provided by the ``extdash'' package.

Example without a shortcut:

\begin{center}\begin{minipage}{2.55in}\vspace{0.6\baselineskip}
x-, y-, and z-coordinates; x-, y-, and z-coordinates;
x-, y-, and z-coordinates; x-, y-, and z-coordinates;
x-, y-, and z-coordinates; x-, y-, and z-coordinates;
\vspace{0.6\baselineskip}\end{minipage}\end{center}

Example with \qco{\\-/}:

\begin{center}\begin{minipage}{2.55in}\vspace{0.6\baselineskip}
x-, y-, and z\-/coordinates; x-, y-, and z\-/coordinates;
x-, y-, and z\-/coordinates; x-, y-, and z\-/coordinates;
x-, y-, and z\-/coordinates; x-, y-, and z\-/coordinates;
\vspace{0.6\baselineskip}\end{minipage}\end{center}

Example with \qco{\\=/}:

\begin{center}\begin{minipage}{2.55in}\vspace{0.6\baselineskip}
x-, y-, and z\=/coordinates; x-, y-, and z\=/coordinates;
x-, y-, and z\=/coordinates; x-, y-, and z\=/coordinates;
x-, y-, and z\=/coordinates; x-, y-, and z\=/coordinates;
\vspace{0.6\baselineskip}\end{minipage}\end{center}

Note that \qco{\\=/} enables hyphenation in elements
of compound words as the same as \qco{\\-/} does.

\subsubsection{Em Dash}
\label{sec:app:styleguide:Em Dash}

Em dashes are used to indicate parenthetic expression.
In perfbook, em dashes are placed without spaces around it.
In \LaTeX\ source, an em dash is represented by \qco{---}.

Example (quote from \cref{sec:app:whymb:Cache Structure}):
\begin{quote}
  This disparity in speed---more than two orders of magnitude---has
  resulted in the multi-megabyte caches found on modern CPUs.
\end{quote}

\subsubsection{En Dash}
\label{sec:app;styleguide:En Dash}

In \LaTeX\ convention, en~dashes (\==) are used for ranges of (mostly)
numbers.
Past revisions of perfbook didn't follow this rule and used
plain dashes (\=/) for such cases.

Now that \co{\\clnrefrange}, \co{\\crefrange},
and their variants, which generate en~dashes, are used for ranges of
cross\-/references, the remaining couple of tens of simple dashes
of other types of ranges have been converted to en~dashes for
consistency.

Example with a simple dash:

\begin{quote}
\begin{fcvref}[ln:app:styleguide:samplecodesnippetlstlbl]
  Lines~\lnref{b}\=/\lnref{e} in
  \cref{lst:app:styleguide:LaTeX Source of Sample Code Snippet (Obsolete)}
  are the contents of the verbbox environment.
  The box is output by the \co{\\theverbbox} macro on \clnref{theverbbox}.
\end{fcvref}
\end{quote}

Example with an en dash:

\begin{quote}
\begin{fcvref}[ln:app:styleguide:samplecodesnippetlstlbl]
  Lines~\lnref{b}\==\lnref{e} in
  \cref{lst:app:styleguide:LaTeX Source of Sample Code Snippet (Obsolete)}
  are the contents of the verbbox environment.
  The box is output by the \co{\\theverbbox} macro on \clnref{theverbbox}.
\end{fcvref}
\end{quote}

\subsubsection{Numerical Minus Sign}
\label{sec:app:styleguide:Numerical Minus Sign}

Numerical minus signs should be coded as math mode minus signs,
namely \qco{$-$}.\footnote{This rule assumes that math mode uses the
  same upright glyph as text mode.
  Our default font choice meets the assumption.
\IfSansSerif{
  Experimental targets with sans-serif fonts such as
  ``1csf'' and ``ebsf'' \emph{do} use a different font
  for math mode figures as of August 2021.}{}
}
For example,

\begin{quote}
  $-30$, rather than -30.
\end{quote}

\subsection{Punctuation}
\label{sec:app:styleguide:Punctuation}

\subsubsection{Ellipsis}
\label{sec:app:styleguide:Ellipsis}

In monospace fonts, ellipses can be expressed by series of periods.
For example:

\begin{quote}
  \verb|Great ... So how do I fix it?|
\end{quote}

However, in proportional fonts, the series of periods is printed
with tight spaces as follows:

\begin{quote}
  Great ... So how do I fix it?
\end{quote}

Standard \LaTeX\ defines the \verb|\dots| macro for this purpose.
However, it has a kludge in the evenness of spaces.
The ``ellipsis'' package redefines the \verb|\dots| macro to fix
the issue.\footnote{To be exact, it is the \co{\\textellipsis} macro
  that is redefined.
  The behavior of \co{\\dots} macro in math mode is not affected.
  The ``amsmath'' package has another definition of \co{\\dots}.
  It is not used in perfbook at the moment.}
By using \verb|\dots|, the above example is typeset as the following:

\begin{quote}
  Great \dots So how do I fix it?
\end{quote}

Note that the ``xspace'' option specified to the ``ellipsis'' package
adjusts the spaces after ellipses depending on what follows them.

For example:

\begin{itemize}[itemsep=.2ex]
\item He said, ``I~\dots really don't remember~\dots''
\item Sequence A: (one, two, three, \dots)
\item Sequence B: (4, 5, \dots, $n$)
\end{itemize}

As you can see, extra space is placed before the comma.

\verb|\dots| macro can also be used in math mode:

\begin{itemize}[itemsep=.2ex]
\item Sequence C: $(1, 2, 3, 5, 8, \dots)$
\item Sequence D: $(10, 12, \dots, 20)$
\end{itemize}

The \verb|\ldots| macro behaves the same as the \verb|\dots| macro.

\subsubsection{Full Stop}
\label{sec:app:styleguide:Full Stop}

\LaTeX\ treats a full stop in front of a white space as an end of
a sentence and puts a slightly wider skip by default (double spacing).
There is an exception to this rule, i.e.\@ where the full stop is next
to a capital letter, \LaTeX\ assumes it represents an abbreviation
and puts a normal skip.

To make \LaTeX\ use proper skips, one need to annotate such exceptions.
For example, given the following \LaTeX\ source:

\begin{VerbatimU}
\begin{quote}
	Lock~1 is owned by CPU~A.
	Lock~2 is owned by CPU~B.  (Bad.)

	Lock~1 is owned by CPU~A\@.
	Lock~2 is owned by CPU~B\@.  (Good.)
\end{quote}
\end{VerbatimU}
%
the output will be as the following:

\begin{quote}
	Lock~1 is owned by CPU~A.
	Lock~2 is owned by CPU~B.  (Bad.)

	Lock~1 is owned by CPU~A\@.
	Lock~2 is owned by CPU~B\@.  (Good.)
\end{quote}

On the other hand, where a full stop is following a lower case
letter, e.g.\@ as in ``Mr.~Smith'', a wider skip will follow
in the output unless it is properly hinted.
Such hintings can be done in one of several ways.

Given the following source,

\begin{VerbatimU}
\begin{itemize}[nosep]
	\item Mr. Smith (bad)
	\item Mr.~Smith (good)
	\item Mr.\ Smith (good)
	\item Mr.\@ Smith (good)
\end{itemize}
\end{VerbatimU}

\noindent%
the result will look as follows:

\begin{itemize}[nosep]
	\item Mr. Smith (bad)
	\item Mr.~Smith (good)
	\item Mr.\ Smith (good)
	\item Mr.\@ Smith (good)
\end{itemize}

\subsection{Floating Object Format}
\label{sec:app:styleguide:Floating Object Format}

\subsubsection{Ruled Line in Table}
\label{sec:app:styleguide:Ruled Line in Table}

They say that tables drawn by using ruled lines of plain \LaTeX\
look ugly.\footnote{
  \url{https://www.inf.ethz.ch/personal/markusp/teaching/guides/guide-tables.pdf}
}
Vertical lines should be avoided and horizontal lines should be
used sparingly, especially in tables of simple structure.

\IfTblCpTop{}{
\floatstyle{plaintop}
\restylefloat{table}
\setlength{\abovetopsep}{-2pt}
\addtolength{\abovecaptionskip}{-2.5pt}
}

\newcommand{\TLo}{T_\mathrm{L}}
\newcommand{\THi}{T_\mathrm{H}}
\newcommand{\CPf}{C_\mathrm{P}}

\Cref{tab:app:styleguide:Refrigeration Power Consumption}
(corresponding to a table from a now-deleted section)
is drawn by using the features of ``booktabs'' and ``xcolor'' packages.
Note that ruled lines of booktabs can not be mixed with
vertical lines in a table.\footnote{
  There is another package named ``arydshln'' which provides dashed lines
  to be used in tables.
  A couple of experimental examples are presented in
  \cref{sec:app:styleguide:Table Layout Experiment}.
}

\begin{table}
\rowcolors{1}{}{lightgray}
\renewcommand*{\arraystretch}{1.2}\centering\small
\begin{tabular}{lrrr}\toprule
Situation
	& $T$ (K)
		& $\CPf$ & \parbox[b]{.75in}{\raggedleft Power per watt\par waste heat (W)} \\
\midrule
Dry Ice
	& $195$
		& $1.990$
			& 0.5 \\
Liquid N$_2$
	& $77$
		& $0.356$
			& 2.8 \\
Liquid H$_2$
	& $20$
		& $0.073$
			& 13.7 \\
Liquid He
	& $4$
		& $0.0138$
			& 72.3 \\
IBM~Q	& $0.015$
		& $0.000051$
			& 19,500.0 \\
\bottomrule
\end{tabular}
\caption{Refrigeration Power Consumption}
\label{tab:app:styleguide:Refrigeration Power Consumption}
\end{table}

\subsubsection{Position of Caption}
\label{sec:app:styleguide:Position of Caption}

In \LaTeX\ conventions, captions of tables are usually placed
above them.
The reason is the flow of your eye movement when you look at them.
Most tables have a row of heading at the top.
You naturally look at the top of a table at first.
Captions at the bottom of tables disturb this flow.
The same can be said of code snippets, which are read from
top to bottom.

For code snippets, the ``ruled'' style chosen for listing
environment places the caption at the top.
See \cref{lst:app:styleguide:Sample Code Snippet}
for an example.

As for tables, the position of caption is tweaked by
\verb|\floatstyle{}| and \verb|\restylefloat{}| macros
in preamble.

Vertical skips below captions are reduced by setting a smaller
value to the \verb|\abovecaptionskip| variable,
which would also affect captions to figures.

In the tables which use horizontal rules of ``booktabs'' package,
the vertical skips between captions and tables are further reduced
by setting a negative value to the \co{\\abovetopsep} variable,
which controls the behavior of \co{\\toprule}.

\subsection{Improvement Candidates}
\label{sec:app:styleguide:Improvement Candidates}

\begin{figure*}\centering
\ebresizewidth{
\begin{minipage}[t][][t]{2.1in}
\resizebox{2.1in}{!}{\includegraphics{cartoons/1kHz}}
\caption{Timer Wheel at 1\,kHz}
\label{fig:app:styleguide:Timer Wheel at 1kHz}
\end{minipage}
\qquad
\begin{minipage}[t][][t]{2.3in}
\resizebox{2.3in}{!}{\includegraphics{cartoons/100kHz}}
\caption{Timer Wheel at 100\,kHz}
\label{fig:app:styleguide:Timer Wheel at 100kHz}
\end{minipage}
}
\end{figure*}

\begin{listing*}%
\caption{Message-Passing Litmus Test (by subfig)}%
\label{lst:app:styleguide:Message-Passing Litmus Test (subfig)}%
{\scriptsize%
\begin{verbbox}[\LstLineNo]
C C-MP+o-wmb-o+o-o.litmus

{
}

P0(int* x0, int* x1) {

  WRITE_ONCE(*x0, 2);
  smp_wmb();
  WRITE_ONCE(*x1, 2);

}

P1(int* x0, int* x1) {

  int r2;
  int r3;

  r2 = READ_ONCE(*x1);
  r3 = READ_ONCE(*x0);

}


exists (1:r2=2 /\ 1:r3=0)
\end{verbbox}
}
\centering
\hspace*{\fill}
\subfloat[Not Enforcing Order]{
  \theverbbox
  \label{sublst:app:styleguide:Not Enforcing Order}
}
\hspace{\fill}
{\scriptsize%
\begin{verbbox}[\LstLineNo]
C C-MP+o-wmb-o+o-rmb-o.litmus

{
}

P0(int* x0, int* x1) {

  WRITE_ONCE(*x0, 2);
  smp_wmb();
  WRITE_ONCE(*x1, 2);

}

P1(int* x0, int* x1) {

  int r2;
  int r3;

  r2 = READ_ONCE(*x1);
  smp_rmb();
  r3 = READ_ONCE(*x0);

}

exists (1:r2=2 /\ 1:r3=0)
\end{verbbox}
}%
\subfloat[Enforcing Order]{%
  \theverbbox
  \label{sublst:app:styleguide:Enforcing Order}
}\hspace*{\fill}%
\end{listing*}

There are a few areas yet to be attempted in perfbook
which would further improve its appearance.
This section lists such candidates.

\subsubsection{Grouping Related Figures/Listings}
\label{sec:app:styleguide:Grouping Related Figures/Listings}

To prevent a pair of closely related figures or listings
from being placed in different pages, it is desirable to group
them into a single floating object.
The ``subfig'' package provides the features to do so.\footnote{
  One problem of grouping figures might be the complexity in
  \LaTeX\ source.}

Two floating objects can be placed side by side by using
\co{\\parbox} or \co{minipage}.
For example,
\cref{fig:advsync:Timer Wheel at 1kHz,fig:advsync:Timer Wheel at 100kHz}
can be grouped together by using a pair of \co{minipage}s
as shown in
\cref{fig:app:styleguide:Timer Wheel at 1kHz,%
fig:app:styleguide:Timer Wheel at 100kHz}.

By using subfig package,
\cref{lst:memorder:Message-Passing Litmus Test (No Ordering),%
lst:memorder:Enforcing Order of Message-Passing Litmus Test}
can be grouped together as shown in
\cref{lst:app:styleguide:Message-Passing Litmus Test (subfig)}
with sub\-/captions (with a minor change of blank line).

Note that they can not be grouped in the same way as
\cref{fig:app:styleguide:Timer Wheel at 1kHz,%
fig:app:styleguide:Timer Wheel at 100kHz}
because the ``ruled'' style prevents their captions
from being properly typeset.

The sub\-/caption can be cited by combining a \verb|\cref{}| macro
and a \verb|\subref{}| macro, for example,
``\cref{lst:app:styleguide:Message-Passing Litmus Test (subfig)}\,%
\subref{sublst:app:styleguide:Not Enforcing Order}''.

It can also be cited by a \verb|\cref{}| macro, for example,
``\cref{sublst:app:styleguide:Enforcing Order}''.
Note the difference in the resulting format.
For the citing by a \verb|\cref{}| to work, you need to place
the \verb|\label{}| macro of the combined floating object
ahead of the definition of subfloats.
Otherwise, the resulting caption number would be off by one
from the actual number.

\subsubsection{Table Layout Experiment}
\label{sec:app:styleguide:Table Layout Experiment}

This section presents some experimental tables
using booktabs, xcolors, and arydshln packages.
The corresponding tables in the text have been converted using one of
the format shown here.
The source of this section can be regarded as a reference to be
consulted when new tables are added in the text.

\begin{table}
\rowcolors{1}{}{lightgray}
\renewcommand*{\arraystretch}{1.1}
\sisetup{group-minimum-digits=4,group-separator={,}}
\centering\small
\begin{tabular}
  {
    l
    S[table-format = 9.1]
    S[table-format = 9.1]
  }
	\toprule
	Operation		& \multicolumn{1}{r}{Cost (ns)}
			& {\parbox[b]{.7in}{\raggedleft Ratio\\(cost/clock)}} \\
	\midrule
	Clock period		&           0.5	&           1.0 \\
	Best-case CAS		&           7.0	&          14.6 \\
	Best-case lock		&          15.4	&          32.3 \\
	Blind CAS		&           7.2	&          15.2 \\
	CAS			&          18.0	&          37.7 \\
	Blind CAS (off-core)	&          47.5	&          99.8 \\
	CAS (off-core)		&         101.9	&         214.0 \\
	Blind CAS (off-socket)	&         148.8	&         312.5 \\
	CAS (off-socket)	&         442.9	&         930.1 \\
	Comms Fabric		&       5 000	&      10 500	\\
	Global Comms		& 195 000 000	& 409 500 000   \\
	\bottomrule
\end{tabular}
\caption{CPU 0 View of Synchronization Mechanisms on 8-Socket System With Intel Xeon Platinum 8176 CPUs @ 2.10GHz}
\label{tab:app:styleguide:CPU 0 View of Synchronization Mechanisms on 8-Socket System With Intel Xeon Platinum 8176 CPUs @ 2.10GHz}
\end{table}

In
\cref{tab:app:styleguide:CPU 0 View of Synchronization Mechanisms on 8-Socket System With Intel Xeon Platinum 8176 CPUs @ 2.10GHz}
(corresponding to
\cref{tab:cpu:CPU 0 View of Synchronization Mechanisms on 8-Socket System With Intel Xeon Platinum 8176 CPUs at 2.10GHz}),
the ``S'' column specifiers provided
by the ``siunitx'' package are used to align numbers.

\Cref{tab:app:styleguide:Synchronization and Reference Counting}
(corresponding to
\cref{tab:together:Synchronizing Reference Counting})
is an example of table with a complex header.
In
\cref{tab:app:styleguide:Synchronization and Reference Counting},
the gap in the mid-rule corresponds to the distinction
which had been represented by double vertical rules before the conversion.
The legends in the frame box appended here explain the abbreviations used
in the matrix.
Two types of memory barrier are denoted by subscripts here.
The legends and subscripts are not present in
\cref{tab:together:Synchronizing Reference Counting}
since they are redundant there.

\begin{table}
\renewcommand*{\arraystretch}{1.25}
\rowcolors{3}{}{lightgray}
\small
\centering
\begin{tabular}{lcccc}
	\toprule
	& \multicolumn{4}{c}{Release} \\
	\cmidrule(l){2-5}
	Acquisition	& Locks
				& \parbox[c]{.5in}{Reference\\Counts}
					& \parbox[c]{.5in}{Hazard\\Pointers}
						& RCU \\
	\cmidrule{1-1} \cmidrule(l){2-5}
	Locks		& $-$	& CAM\textsubscript{R}	& M	& CA  \\
	\parbox[c][6ex]{.6in}{Reference\\Counts}
			& A	& AM\textsubscript{R}    & M	& A   \\
	\parbox[c][6ex]{.6in}{Hazard\\Pointers}
			& M	& M	& M	& M   \\
	RCU		& CA	& M\textsubscript{A}CA	& M	& CA  \\
	\bottomrule
\end{tabular}

\vspace{5pt}\hfill
\framebox[\width]{\footnotesize\setlength{\tabcolsep}{3pt}
\rowcolors{1}{}{}
  \begin{tabular}{lrp{2in}}
	Key:	& A: & Atomic counting \\
		& C: & Check combined with the atomic acquisition operation \\
		& M: & Full memory barriers required \\
		& M\textsubscript{R}: & Memory barriers required only on release \\
		& M\textsubscript{A}: & Memory barriers required on acquire \\
  \end{tabular}
}
\caption{Synchronization and Reference Counting}
\label{tab:app:styleguide:Synchronization and Reference Counting}
\end{table}

\Cref{tab:app:styleguide:Cache Coherence Example}
(corresponding to
\cref{tab:app:whymb:Cache Coherence Example})
is a sequence diagram drawn as a table.

\begin{table*}
\small
\centering
\renewcommand*{\arraystretch}{1.2}
\rowcolors{6}{}{lightgray}
% "6" is chosen due to disturbance of row count by cmidrule.
% The command definition is:
%     \rowcolors{<row>}{<odd-row color>}{<even-row color>}
% Here, <row> specifies the row count where the coloring start.
% In this table, the "Seq = 0" row is the 3rd row, so a "3" would
% be a right choice.
% However, because of the \cmidrule{} commands used in the heading,
% internal row count of the "Seq = 0" row becomes "6".
% This is why the 3rd row has the background color of <even-row color>.
%
% \cline of plain LaTeX also interfares the row count.
\ebresizewidth{
\begin{tabular}{rclcccccc}
	\toprule
	& & & \multicolumn{4}{c}{CPU Cache} & \multicolumn{2}{c}{Memory} \\
	\cmidrule(lr){4-7} \cmidrule(l){8-9}
	Sequence \# & CPU \# & Operation & 0 & 1 & 2 & 3 & 0 & 8 \\
	\cmidrule(r){1-3} \cmidrule(lr){4-7} \cmidrule(l){8-9}
%	Seq CPU Operation	------------- CPU -------------   - Memory -
%				   0	   1	   2	   3	    0   8
	0 &   & Initial State	& $-$/I & $-$/I & $-$/I & $-$/I   & V & V \\
	1 & 0 & Load		& 0/S &   $-$/I & $-$/I & $-$/I   & V & V \\
	2 & 3 & Load		& 0/S &   $-$/I & $-$/I & 0/S     & V & V \\
	3 & 0 & Invalidation	& 8/S &   $-$/I & $-$/I & 0/S     & V & V \\
	4 & 2 & RMW		& 8/S &   $-$/I & 0/E &   $-$/I   & V & V \\
	5 & 2 & Store		& 8/S &   $-$/I & 0/M &   $-$/I   & I & V \\
	6 & 1 & Atomic Inc	& 8/S &   0/M &   $-$/I & $-$/I   & I & V \\
	7 & 1 & Writeback	& 8/S &   8/S &   $-$/I & $-$/I   & V & V \\
	\bottomrule
\end{tabular}
}
\caption{Cache Coherence Example}
\label{tab:app:styleguide:Cache Coherence Example}
\end{table*}

\Cref{tab:app:styleguide:RCU Publish-Subscribe and Version Maintenance APIs}
is a tweaked version of
\cref{tab:defer:RCU Publish-Subscribe and Version Maintenance APIs}.
Here, the ``Category'' column in the original is removed
and the categories are indicated in rows of bold-face font
just below the mid-rules.
This change makes it easier for \verb|\rowcolors{}| command of
``xcolor'' package to work properly.

\Cref{tab:app:styleguide:RCU Publish-Subscribe and Version Maintenance APIs (colortbl)}
is another version which keeps original columns and colors rows only where
a category has multiple rows.
This is done by combining \verb|\rowcolors{}| of ``xcolor'' and
\verb|\cellcolor{}| commands of the ``colortbl'' package
(\verb|\cellcolor{}| overrides \verb|\rowcolors{}|).

In
\cref{tab:defer:RCU Publish-Subscribe and Version Maintenance APIs},
the latter layout without partial row coloring has been
chosen for simplicity.

\begin{table*}
\rowcolors{2}{}{blue!15}
\renewcommand*{\arraystretch}{1.1}
\footnotesize
\centering
\ebresizewidth{
\begin{tabular}{lll}
\toprule
	Primitives &
		Availability &
			Overhead \\
\midrule
	\multicolumn{3}{l}{\bfseries List traversal} \\
	\tco{list_for_each_entry_rcu()} &
		2.5.59 &
			Simple instructions (memory barrier on Alpha) \\
\midrule
	\multicolumn{3}{l}{\bfseries List update} \\
	\tco{list_add_rcu()} &
		2.5.44 &
			Memory barrier \\
	\rowcolor{lightgray}\tco{list_add_tail_rcu()} &
		2.5.44 &
			Memory barrier \\
	\tco{list_del_rcu()} &
		2.5.44 &
			Simple instructions \\
	\rowcolor{lightgray}\tco{list_replace_rcu()} &
		2.6.9 &
			Memory barrier \\
	\tco{list_splice_init_rcu()} &
		2.6.21 &
			Grace-period latency \\
\midrule
	\multicolumn{3}{l}{\bfseries Hlist traversal} \\
	\tco{hlist_for_each_entry_rcu()} &
		2.6.8 &
			Simple instructions (memory barrier on Alpha) \\
\midrule
	\multicolumn{3}{l}{\bfseries Hlist update} \\
	\tco{hlist_add_after_rcu()} &
		2.6.14 &
			Memory barrier \\
	\rowcolor{lightgray}\tco{hlist_add_before_rcu()} &
		2.6.14 &
			Memory barrier \\
	\tco{hlist_add_head_rcu()} &
		2.5.64 &
			Memory barrier \\
	\rowcolor{lightgray}\tco{hlist_del_rcu()} &
		2.5.64 &
			Simple instructions \\
	\tco{hlist_replace_rcu()} &
		2.6.15 &
			Memory barrier \\
\midrule
	\multicolumn{3}{l}{\bfseries Pointer traversal} \\
	\tco{rcu_dereference()} &
		2.6.9 &
			Simple instructions (memory barrier on Alpha) \\
\midrule
	\multicolumn{3}{l}{\bfseries Pointer update} \\
	\tco{rcu_assign_pointer()} &
		2.6.10 &
			Memory barrier \\
\bottomrule
\end{tabular}
}
\caption{RCU Publish-Subscribe and Version Maintenance APIs}
\label{tab:app:styleguide:RCU Publish-Subscribe and Version Maintenance APIs}
\end{table*}

\begin{table*}
\renewcommand*{\arraystretch}{1.2}
\rowcolors{3}{lightgray}{}
\footnotesize
\centering
\ebresizewidth{
\begin{tabular}{lllp{1.2in}}\toprule
Category &
	Primitives &
		Availability &
			Overhead \\
\midrule
List traversal &
	\tco{list_for_each_entry_rcu()} &
		2.5.59 &
			Simple instructions (memory barrier on Alpha) \\
\midrule
\cellcolor{white}List update &
	\tco{list_add_rcu()} &
		2.5.44 &
			Memory barrier \\
&
	\tco{list_add_tail_rcu()} &
		2.5.44 &
			Memory barrier \\
\cellcolor{white} &
	\tco{list_del_rcu()} &
		2.5.44 &
			Simple instructions \\
&
	\tco{list_replace_rcu()} &
		2.6.9 &
			Memory barrier \\
\cellcolor{white} &
	\tco{list_splice_init_rcu()} &
		2.6.21 &
			Grace-period latency \\
\midrule
Hlist traversal &
	\tco{hlist_for_each_entry_rcu()} &
		2.6.8 &
			Simple instructions (memory barrier on Alpha) \\
\midrule
\cellcolor{white}Hlist update &
	\tco{hlist_add_after_rcu()} &
		2.6.14 &
			Memory barrier \\
&
	\tco{hlist_add_before_rcu()} &
		2.6.14 &
			Memory barrier \\
\cellcolor{white} &
	\tco{hlist_add_head_rcu()} &
		2.5.64 &
			Memory barrier \\
&
	\tco{hlist_del_rcu()} &
		2.5.64 &
			Simple instructions \\
\cellcolor{white} &
	\tco{hlist_replace_rcu()} &
		2.6.15 &
			Memory barrier \\
\midrule\hiderowcolors
Pointer traversal &
	\tco{rcu_dereference()} &
		2.6.9 &
			Simple instructions (memory barrier on Alpha) \\
\midrule
Pointer update &
	\tco{rcu_assign_pointer()} &
		2.6.10 &
			Memory barrier \\
\bottomrule
\end{tabular}
}
\caption{RCU Publish-Subscribe and Version Maintenance APIs}
\label{tab:app:styleguide:RCU Publish-Subscribe and Version Maintenance APIs (colortbl)}
\end{table*}

\Cref{tab:app:styleguide:Memory Misordering: Store-Buffering Sequence of Events}
(corresponding to
\cref{tab:memorder:Memory Misordering: Store-Buffering Sequence of Events})
is also a sequence diagram drawn as a tabular object.

\begin{table*}
\rowcolors{6}{}{lightgray}
\renewcommand*{\arraystretch}{1.1}
\small
\centering\OneColumnHSpace{-0.1in}
\ebresizewidth{
\begin{tabular}{rllllll}
	\toprule
	& \multicolumn{3}{c}{CPU 0} & \multicolumn{3}{c}{CPU 1} \\
	\cmidrule(l){2-4} \cmidrule(l){5-7}
	& Instruction & Store Buffer & Cache &
		Instruction & Store Buffer & Cache \\
	\cmidrule{1-1} \cmidrule(l){2-4} \cmidrule(l){5-7}
	1 & (Initial state) & & \tco{x1==0} &
		(Initial state) & & \tco{x0==0} \\
	2 & \tco{x0 = 2;} & \tco{x0==2} & \tco{x1==0} &
		\tco{x1 = 2;} & \tco{x1==2} & \tco{x0==0} \\
	3 & \tco{r2 = x1;} (0) & \tco{x0==2} & \tco{x1==0} &
		\tco{r2 = x0;} (0) & \tco{x1==2} & \tco{x0==0} \\
	4 & (Read-invalidate) & \tco{x0==2} & \tco{x0==0} &
		(Read-invalidate) & \tco{x1==2} & \tco{x1==0} \\
	5 & (Finish store) & & \tco{x0==2} &
		(Finish store) & & \tco{x1==2} \\
	\bottomrule
\end{tabular}
}
\caption{Memory Misordering: Store-Buffering Sequence of Events}
\label{tab:app:styleguide:Memory Misordering: Store-Buffering Sequence of Events}
\end{table*}

\Cref{tab:app:styleguide:Refrigeration Power Consumption (arydshln)}
shows another version of
\cref{tab:app:styleguide:Refrigeration Power Consumption}
with dashed horizontal and vertical rules of the arydshln package.

\setlength\dashlinedash{.5pt}
\setlength\dashlinegap{1pt}

\begin{table}
\renewcommand*{\arraystretch}{1.2}\centering\small
\begin{tabular}{l:r:r:r}\toprule
Situation
	& $T$ (K)
		& $\CPf$ & \parbox[b]{.75in}{\raggedleft Power per watt\par waste heat (W)} \\
\hline
Dry Ice
	& $195$
		& $1.990$
			& 0.5 \\ \hdashline
Liquid N$_2$
	& $77$
		& $0.356$
			& 2.8 \\ \hdashline
Liquid H$_2$
	& $20$
		& $0.073$
			& 13.7 \\ \hdashline
Liquid He
	& $4$
		& $0.0138$
			& 72.3 \\ \hdashline
IBM~Q	& $0.015$
		& $0.000051$
			& 19,500.0 \\
\bottomrule
\end{tabular}
\caption{Refrigeration Power Consumption}
\label{tab:app:styleguide:Refrigeration Power Consumption (arydshln)}
\end{table}

In this case, the vertical dashed rules seems unnecessary.
The one without the vertical rules is shown in
\cref{tab:app:styleguide:Refrigeration Power Consumption (arydshln-2)}.

\begin{table}
\renewcommand*{\arraystretch}{1.2}\centering\small
\begin{tabular}{lrrr}\toprule
Situation
	& $T$ (K)
		& $\CPf$ & \parbox[b]{.75in}{\raggedleft Power per watt\par waste heat (W)} \\
\midrule
Dry Ice
	& $195$
		& $1.990$
			& 0.5 \\ \hdashline
Liquid N$_2$
	& $77$
		& $0.356$
			& 2.8 \\ \hdashline
Liquid H$_2$
	& $20$
		& $0.073$
			& 13.7 \\ \hdashline
Liquid He
	& $4$
		& $0.0138$
			& 72.3 \\ \hdashline
IBM~Q	& $0.015$
		& $0.000051$
			& 19,500.0 \\
\bottomrule
\end{tabular}
\caption{Refrigeration Power Consumption}
\label{tab:app:styleguide:Refrigeration Power Consumption (arydshln-2)}
\end{table}

\IfTblCpTop{}{
\floatstyle{plain}
\restylefloat{table}
\addtolength{\abovecaptionskip}{2.5pt}
\setlength{\abovetopsep}{0pt}
}

\FloatBarrier

\subsubsection{Miscellaneous Candidates}
\label{sec:app:styleguide:Miscellaneous Candidates}

Other improvement candidates are listed in the source of this
section as comments.

% Ugly line break by \co{}
%                                 __
%        atomic_store()
%
%                           seqlock_
%        t
%
%   Is there any way to prevent these breaks?
%   Maybe we need an on-the-fly script to convert such \co{}s
%   to couples of \co{}s.
%   Example:
%     \co{__atomic_store()} -> \co{__}\co{atomic_store()}
%     \co{seqlock_t} ->        \co{seqlock_}\co{t}
